# payment 패키지 구현 내용

> 결제는 아임포트API를 사용한다.

## PostApiController 구현 내용

### POST - 결제 완료 정보 저장

 사용자가 결제하면 아임포트API가 처리하고 결과값을 돌려준다. 아임포트API가 response한 데이터를 DB에 저장하라고 요청한다.
 
### PUT - 환불

 결제의 경우 서버에서 처리해줄 일이 별로 없다. 아임포트API가 결제로직을 처리하고 반환한 값을 DB에 저장하면 그만이다.
 환불의 경우는 서버에서 처리해줘야 하는 작업이 몇 개 있다. 간단하게 환불 로직을 정리하자면 이렇다.
 
1. 존재하는 결제내역인지 DB에서 확인한다.
2. 이미 취소된 결제 내역은 아닌지 확인한다.
3. 아임포트API에 Access Token을 요청한다.
   
   > 참고로 Access Token은 최종적으로 환불 요청을 보낼 때 HTTP Header에 넣어서 보내야한다.
    클라이언트에서 이 작업을 하면 보안에 취약해지므로 서버에서 처리하라고 아임포트 Docs에서 권장하고 있다.
   
4. 아임포트API를 사용할 때 발급받는 REST API key와 secret key를 HTTP body에 넣고, header에 Access Token을 추가한다.
5. RestTemplate객체를 이용해서 환불을 처리하는 아임포트API에게 요청을 보낸다.
6. 200메세지가 돌아오면 DB에서 해당 결제 내용을 취소된 결제 내역으로 변경한다.(cancel=true, cancel_date=now())
7. 클라이언트에게 환불이 처리되었다고 알린다.
