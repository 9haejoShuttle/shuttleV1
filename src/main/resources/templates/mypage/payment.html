<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <title>ê²°ì œ</title>
</head>
<body>
<div class="container">
    <div>
    <h2>ê²°ì œí•  ë…¸ì„ </h2>
        <button id="btn-payment" class="btn btn-outline-success">ê²°ì œí•˜ê¸°</button>
    </div>

    <div>
        <h2 th:text="${user.name} + 'ë‹˜ì˜ ê²°ì œ ë‚´ì—­'"></h2>
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">No</th>
                    <th>ê²°ì œ ë‚´ìš©</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ê²°ì œ ë°©ë²•</th>
                    <th>ê²°ì œì¼</th>
                    <th>í• ë¶€</th>
                    <th>ê²°ì œ ì·¨ì†Œ</th>
                    <th>ì·¨ì†Œì¼</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="payment : ${payments}" class="payment-row">
                    <td class="payment-id" th:text="${payment.id}"></td>
                    <td th:text="${payment.name}"></td>
                    <td th:text="${payment.paidAmount}"></td>
                    <td th:text="${payment.payMethod}"></td>
                    <td th:text="${payment.cardQuaota}"></td>
                    <td th:text="${#temporals.format(payment.paidAt, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:if="${!payment.cancel}">
                        <a href="" class="btn-cancelPay">ê²°ì œ ì·¨ì†Œ</a>
                    </td>
                    <td th:if="${payment.cancel}">
                        <span>ì·¨ì†Œëœ ë‚´ì—­</span>
                    </td>
                    <td>--</td>
                </tr>
            </tbody>
        </table>
    </div>
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:if="${!payments.isFirst() && !payments.hasPrevious()}">
                <a class="page-link" th:href="@{'/mypage/payment?page='+${payments.getNumber() - 1}}">Previous</a>
            </li>
            <li class="page-item" th:classappend="${i == payments.getNumber()}? active"
                th:each="i: ${#numbers.sequence(0, payments.getTotalPages() - 1)}">
                <a class="page-link" th:href="@{'/mypage/payment?page=' + ${i}}" th:text="${i+1}"></a>
            </li>
            <li class="page-item" th:if="${!payments.isLast() && !payments.hasNext()}">
                <a class="page-link" th:href="@{'/mypage/payment?page='+${payments.getNumber() + 1}}">Next</a>
            </li>
        </ul>
    </nav>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>

<script>
    const header = document.getElementsByName('_csrf_header')[0].content;
    const token = document.getElementsByName('_csrf')[0].content;

    const listener = {
        init: function () {
            const btnPayment = document.getElementById('btn-payment');
            let btnCancelPayment = document.querySelectorAll('.payment-row');

            IMP.init("imp30641138");

            btnPayment.addEventListener('click', () => {
                this.paymentListener();
            }); //payment listener

            //ê²°ì œ ì·¨ì†Œ
            btnCancelPayment.forEach((btn) => {
                this.cancelPaymentListener(btn);
            });

        }, //init()
        paymentListener : function () {
            IMP.request_pay({
                pg : 'inicis',
                pay_method : 'card',
                merchant_uid : 'merchant_' + new Date().getTime(),
                name : 'ëª¨ë‘ì˜ ì…”í‹€ ê²°ì œ ì„œë¹„ìŠ¤',
                amount : 100,
                buyer_email : 'iamport@siot.do',
                buyer_name : 'testUser',
                buyer_tel : '010-1234-5678',
                buyer_addr : 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™',
                buyer_postcode : '123-456'
            }, function(rsp) {
                if ( rsp.success ) {
                    //[1] ì„œë²„ë‹¨ì—ì„œ ê²°ì œì •ë³´ ì¡°íšŒë¥¼ ìœ„í•´ jQuery ajaxë¡œ imp_uid ì „ë‹¬í•˜ê¸°
                    $.ajax({
                        url: "/api/payment", //cross-domain errorê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë™ì¼í•œ ë„ë©”ì¸ìœ¼ë¡œ ì „ì†¡
                        contentType: "application/json; charset=utf-8",
                        type: 'POST',
                        dataType: 'json',
                        data: JSON.stringify({
                            applyNum : rsp.apply_num,
                            buyerEmail : rsp.buyer_email,
                            cardQuaota : rsp.card_quaota,
                            impUid : rsp.imp_uid,
                            merchantUid : rsp.merchant_uid,
                            name : rsp.name,
                            paidAmount : rsp.paid_amount,
                            paidAt : rsp.paid_at,
                            payMethod : rsp.pay_method,
                            provider : rsp.pg_provider,
                            pgTid : rsp.pg_tid,
                            pgType : rsp.pg_type,
                            success : rsp.success
                        }),
                        beforeSend : function (xhr) {
                            xhr.setRequestHeader(header, token);
                        }
                    }).done(function (response) {
                        alert('helo');
                    })
                } else {
                    var msg = 'ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
                    msg += 'ì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;

                    alert(msg);
                }
                alert("ê²°ì œ ë˜ì—ˆìŠµë‹ˆë‹¤ğŸ˜„");
                location.href='/mypage/payment';
            });
        }, // ê²°ì œ

        cancelPaymentListener : function (btn) {
            const existAtag = !btn.getElementsByTagName('a').length == 0;

            if (existAtag) {
                let btnCancelPay = btn.querySelector('.btn-cancelPay');

                btnCancelPay.addEventListener('click', () => {
                    let paymentId = btn.querySelector('.payment-id').textContent;
                    if (confirm('ê²°ì œë¥¼ ì·¨ì†Œí•˜ê² ìŠµë‹ˆê¹Œ?')) {
                        $.ajax({
                            url: "/api/payment",
                            type: "PUT",
                            contentType: "application/json",
                            dataType: "JSON",
                            data: JSON.stringify({
                                "id": paymentId, // í™˜ë¶ˆê¸ˆì•¡
                                "reason": "í…ŒìŠ¤íŠ¸ ê²°ì œí™˜ë¶ˆ " // í™˜ë¶ˆì‚¬ìœ 
                            }),
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader(header, token);
                            },
                            success: function (rsp) {
                                alert(rsp);
                            }
                        }).done(function (response) {
                            console.log(response);
                            alert('success');
                        }).fail(function (error) {
                            console.log(error);
                            alert('error')
                        });

                        //doneí•¨ìˆ˜ê°€ ì‘ë™í•˜ì§€ ì•Šì•„ì„œ ì„ì‹œë¡œ ë©”ì„¸ì§€ ë„ì›Œì¤Œ.
                        alert('ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        //location.href='/mypage/payment';
                    }
                }); //cancelListener
            } //if(existAtag)
        } //ê²°ì œ ì·¨ì†Œ
    } //listener()

    listener.init();

</script>
</body>
</html>